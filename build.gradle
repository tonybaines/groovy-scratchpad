usePlugin 'groovy'
usePlugin 'eclipse'

easybReportDir=dir('build/reports/easyb')

repositories {
    mavenCentral()
}

configurations {
	easyb
}

dependencies {
    groovy group: 'org.codehaus.groovy', name: 'groovy-all', version: '1.6.0'
    testCompile group: 'junit', name: 'junit', version: '4.4'
    easyb group: 'org.easyb', name: 'easyb', version: '0.9.6'
    easyb group: 'commons-cli', name: 'commons-cli', version: '1.1'
}

task easyb << {
	pattern = '**/' + (System.properties['story'] ?: '*') + 'Story.groovy'
	ant.taskdef(name: 'easyb', classname: 'org.easyb.ant.BehaviorRunnerTask', classpath: configurations.easyb.asPath)
    ant.easyb(failureProperty: 'easyb.failed') {
      classpath {
		 pathelement(path: configurations.easyb.asPath)
		 pathelement(path: configurations.testRuntime.asPath)
      }
      report(location: "${easybReportDir.dir}/story.txt", format: 'txtstory')
      report(location: "${easybReportDir.dir}/story.xml", format: 'xml')
      report(location: "${easybReportDir.dir}/story.html", format: 'html')
      behaviors(dir: 'src/test/groovy') {
        include(name: pattern)
      }
    }
    ant.fail(if: 'easyb.failed', message: 'EasyB stories failed')
}
easyb.dependsOn easybReportDir
test.dependsOn easyb